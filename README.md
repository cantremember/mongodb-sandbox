# mongodb-sandbox

Launch a stand-alone MongoDB Topology for use within a Test Suite.

  [![Build status][travis-img]][travis-url]
  [![License][license-img]][license-url]


## Purpose

`mongodb-sandbox` provides an easy way to run a self-contained MongoDB Topology
within the runtime execution of a Test Suite,
participating in its lifecycle hooks;


## Installation

```bash
npm install --save-dev @cantremember/mongodb-sandbox
```


## Features

[MongoDB binaries](https://www.mongodb.com/download-center) are automatically downloaded, if not already present.
The Test Case timeout is automatically extended to 90s to accomodate time spent on

- downloading the MongoDB binaries
- launching up the Topology

All Collections in the Sandbox Database get purged at the end of every Test Case.

*As a safety measure*, immediately after launching its Topology's daemon,
the [Lifecycle](JSDOC.md#Lifecycle) connects to the [Sandbox](JSDOC.md#Sandbox) and detects the presence of Documents.
After all, if it's truly a volatile Sandbox, then *no Documents should be found*.
If any are found, then it's possible that the Client has connected to a "real" Database by mistake;

- the Test Suite gets terminated
- the "real" Database is left untouched


## An Example

Here's how to embed a [Lifecycle](JSDOC.md#Lifecycle) into the [mocha](https://github.com/mochajs/mocha) Test Framework,
and within a Test Case, connect your own [MongoClient](https://github.com/mongodb/node-mongodb-native/blob/master/lib/mongo_client.js) instance
to the [Sandbox](JSDOC.md#Sandbox).

> Please consult the [JSDocs](./JSDOC.md) for additional Examples.

```javascript
const { expect } = require('chai');
const { MongoClient } = require('mongodb');
const { createSandbox } = require('@cantremember/mongodb-sandbox');


const lifecycle = createSandbox().lifecycle();

before(lifecycle.beforeAll);
beforeEach(lifecycle.beforeEach);
afterEach(lifecycle.afterEach);
after(lifecycle.afterAll);


describe('the Sandbox', () => {
  const { sandbox } = lifecycle;

  it('is running', () => {
    expect(sandbox.isRunning).to.equal(true);
  });

  it('can be pinged', () => {
    const { url } = sandbox.options;

    return MongoClient.connect(url, { useNewUrlParser: true })
    .then((client) => {
      return client.db().admin().ping()
      .then((response) => {
        expect(response).to.deep.equal({ ok: 1 });

        return client.close();
      });
    });
  });
});
```


## Documentation

Please consult the [JSDocs](./JSDOC.md).


## On the Shoulders of Giants

`mongodb-sandbox` is an assemblage of

- [mongodb-prebuilt](https://github.com/winfinit/mongodb-prebuilt)
- [portfinder](https://github.com/indexzero/node-portfinder)
- [mongodb-topology-manager](https://github.com/mongodb-js/mongodb-topology-manager)

The module produces additional logging via [debug](https://github.com/visionmedia/debug).

```bash
// when running the Test Suite for your project ...
DEBUG=mongodb-sandbox npm test
```

Documentation is generated by [jsdoc-to-markdown](https://github.com/jsdoc2md/jsdoc-to-markdown).


## TODO

- [ ] Support for ReplicaSet Topology (Server-only for now)
- [ ] Auto-timeout extension for Test Frameworks *other than* [mocha](https://github.com/mochajs/mocha)


## Why Mocha?

> C'mon buddy, that's the ["nobody ever got fired for buying IBM equipment"](https://en.wikipedia.org/wiki/Fear,_uncertainty_and_doubt)
> of JavaScript testing frameworks.
> Couldn't you use something a bit *cooler?*

Honestly, I tried, but

- [tape](https://github.com/substack/tape) doesn't seem to have the necessary [Lifecycle](./JSDOC.md#lifecycle) hook support.
- [ava](https://github.com/avajs/ava)'s multi-process concurrency makes it *incredibly* difficult to start up a Sandbox,
  particularly at the juncture of allocating & reserving a unique port.
  So for the moment, `ava` and other concurrent-running Test Frameworks **are not supported**.
- I find [jest](https://github.com/facebook/jest) to be too opinionated and React-focused.

Whereas [mocha](https://github.com/mochajs/mocha) is perfectly designed for the job at hand.

So *that's* why.


## License

WTFPL.  Copyright (C) 2004 Sam Hocevar <sam@hocevar.net>


[travis-img]: https://img.shields.io/travis/cantremember/mongodb-sandbox.svg?style=flat-square
[travis-url]: https://travis-ci.org/cantremember/mongodb-sandbox
[license-img]: https://img.shields.io/badge/license-WTFPL-blue.svg?style=flat-square
[license-url]: http://www.wtfpl.net/
